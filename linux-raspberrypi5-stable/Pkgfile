# Description: Modular kernel config from sarpi.penthux.net
# URL: https://github.com/raspberrypi/linux
# Maintainer: mac-a-r0ni, j at lngn dot net
# Depends on: cpio dracut

name=linux-raspberrypi5-stable
version=6.6.13
release=1
source=(https://github.com/mac-a-r0ni/linux/archive/v${version}/linux-$version.tar.gz
	dotconfig)

PKGMK_NO_STRIP="yes"
_portdir=$PWD

_disableopt() {
	sed -i "s/$1=.*/# $1 is not set/" .config
}

build() {
	cd linux-$version

	make mrproper

	if [ -f $_portdir/config ]; then
		cp $_portdir/config .config
	else
		cp ../dotconfig .config
	fi

	make olddefconfig

#	sed '/^CONFIG_LOCALVERSION=/d' -i .config
#	echo 'CONFIG_LOCALVERSION="-CRUX"' >> .config

	kernver=${version}$(grep CONFIG_LOCALVERSION= .config | cut -d '"' -f2)

	make bcm2712_defconfig
	make -j5 Image.gz modules dtbs
	make INSTALL_MOD_PATH=$PKG modules_install

	mkdir -p $PKG/boot/dtb/broadcom
	mkdir -p $PKG/boot/overlays

	# RPI5 kernel MUST be named kernel8.img OR kernel_2712.img
	cp arch/arm64/boot/Image.gz $PKG/boot/kernel_2712.img
	cp System.map $PKG/boot/System.map
	cp arch/arm64/boot/dts/broadcom/*.dtb $PKG/boot/dtb/broadcom
	cp arch/arm64/boot/dts/overlays/*.dtb* $PKG/boot/overlays
	rm $PKG/lib/modules/$version-v8-16k/build
#	ln -s /usr/src/linux {/lib/modules/$version-v8-16k/build,/lib/modules/$version-v8-16k/source}
}
